# Vanity Service 性能说明

## Linux 环境配置

### 快速设置

```bash
# 1. 设置可执行权限
chmod +x setup_linux.sh build_vanitygen.sh

# 2. 运行设置脚本
./setup_linux.sh

# 3. 设置环境变量（建议添加到 .env 文件）
export DEFAULT_TIMEOUT=15  # 更长的超时时间
export VPP_DEBUG=1         # 启用调试日志（可选）
```

### 手动构建 vanitygen-plusplus

```bash
cd vanitygen-plusplus
make clean
make all  # 构建所有版本（包括 GPU 版本）

# 如果没有 GPU/OpenCL，只构建 CPU 版本
make vanitygen++ keyconv
```

## 当前生成速度慢的原因

### 1. 匹配长度

现在匹配固定前缀后的 4 位字符（不包括固定前缀），难度适中：

| 地址类型 | 匹配位数 | 理论组合数 | 难度级别 |
|---------|---------|-----------|---------|
| BTC/TRON (Base58) | 4位 | 58⁴ = 11,316,496 | 中等 |
| ETH (十六进制) | 4位 | 16⁴ = 65,536 | 较低 |
| BTC Bech32 | 4位 | 32⁴ = 1,048,576 | 中等 |

### 2. 超时时间设置

默认超时时间只有 1.5 秒 (`DEFAULT_TIMEOUT=1.5`)，对于 4 位字符匹配来说可能不够。

## 优化建议

### 1. 增加超时时间

在 `.env` 文件中设置更长的超时时间：

```bash
# 建议设置为 10-30 秒
DEFAULT_TIMEOUT=10
```

### 2. 使用 GPU 加速

确保使用 GPU 版本的 vanitygen-plusplus：
- `oclvanitygen++` 或 `oclvanitygen`（GPU版）
- 而不是 `vanitygen++` 或 `vanitygen`（CPU版）

### 3. 设置 GPU 参数

可以通过环境变量指定 GPU：

```bash
# 选择平台和设备
VPP_PLATFORM=0  # OpenCL 平台索引
VPP_DEVICE=0    # GPU 设备索引
```

### 4. 调整服务器调用时的超时

在 `server/vanity_service_client.py` 中调整超时：

```python
# 原来可能是：
response = await session.post(url, json=data, timeout=5)

# 改为：
response = await session.post(url, json=data, timeout=30)
```

## 预期生成时间

基于 vanitygen-plusplus 的性能（以 RTX 3070 为例）：

| 地址类型 | 匹配长度 | 预计时间 |
|---------|---------|---------|
| BTC (1开头) | 1 + 4位 | 1-5秒 |
| ETH (0x开头) | 0x + 4位 | <1秒 |
| TRON (T开头) | T + 4位 | 1-5秒 |

**注意**：实际时间取决于 GPU 性能和运气。

## 性能监控

### 检查使用的是 CPU 还是 GPU

```python
# 在服务器上运行
cd vanity-service
python3 -c "
from app.utils.vanitygen_plusplus import _find_all_exes
exes = _find_all_exes()
for exe in exes:
    if 'ocl' in exe:
        print(f'GPU版本: {exe}')
    else:
        print(f'CPU版本: {exe}')
"
```

### 启用调试日志

```bash
VPP_DEBUG=1 python main.py
```

这会显示：
- 使用的可执行文件（oclvanitygen++ = GPU，vanitygen++ = CPU）
- 执行的命令
- 实时输出
- 生成进度

### 判断当前使用情况

如果日志显示：
- `[VPP] exec: ['oclvanitygen++', ...]` - 正在使用 GPU
- `[VPP] exec: ['vanitygen++', ...]` - 正在使用 CPU

### 强制使用特定版本

可以通过删除或重命名文件来控制使用哪个版本：
```bash
# 只使用 CPU 版本
mv vanitygen-plusplus/oclvanitygen++ vanitygen-plusplus/oclvanitygen++.bak

# 只使用 GPU 版本  
mv vanitygen-plusplus/vanitygen++ vanitygen-plusplus/vanitygen++.bak
```
